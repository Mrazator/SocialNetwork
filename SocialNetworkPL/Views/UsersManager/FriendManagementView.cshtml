@using Castle.Core.Internal
@using SocialNetworkBL.DataTransferObjects
@model SocialNetworkPL.Models.FindUsersModel

@if (User.Identity.IsAuthenticated)
{
    <div class="FriendManagement col-md-7">
        @using (Html.BeginForm("Index", "UsersManager", FormMethod.Get, new { @class = "form-search" }))
        {
            <div class="form-group">

                @Html.TextBox("subname", null, new
                {
                    @class = "form-control",
                    id = "search-subname",
                    placeholder = "Enter nickname"
                })

            </div>

            <button class="btn btn-primary" type="submit">Find</button>
        }

        <table class="table">
            <tbody>
            @{
                var requestedFriendsYetNotAcceptedIds = Model.User.Friends
                    ?.Where(x => !x.IsAccepted)
                    .Select(x => x.User2Id)
                    .ToList();

                var friendsWaitingForMyAcceptance = Model.User.Friends
                    ?.Where(x => !x.IsAccepted)
                    .ToList();

                var friends = Model.User.Friends;
                   
            }

            @foreach (var user in Model.Users)
            {
                if (user.NickName != Model.User.NickName)
                {
                    <tr>
                        <th scope="row">
                            @{ var pathToImg = "../../Assets/img/girl-" + user.Id + "-400.jpg";} 
                            <div class="profile-picture" style="background-image: url(@pathToImg)"></div>
                            @Html.ActionLink(user.NickName, "Index", "UserProfile",new {nickName = user.NickName}, null)
                        </th>

                        <td>
                            @if (requestedFriendsYetNotAcceptedIds != null  && requestedFriendsYetNotAcceptedIds.Contains(user.Id))
                            {
                                <input type="submit" value="Waiting for confirmation" class="btn btn-default" />
                            }
                            else if (friendsWaitingForMyAcceptance != null && !friendsWaitingForMyAcceptance.Where(x => x.User1Id == user.Id).IsNullOrEmpty())
                            {
                                var friendship = friendsWaitingForMyAcceptance
                                    .Select(x => x.User1Id == user.Id)
                                    .FirstOrDefault();

                                using (Html.BeginForm("AcceptFriend", "UsersManager", new { friendId = user.Id }, FormMethod.Post, null))
                                {
                                    <input type="submit" value="Accept friendship" class="btn btn-success" />
                                }
                            }
                            else
                            {
                                var friendshipDtos = friends as IList<FriendshipDto> ?? friends.ToList();
                                if  ( friends != null && !friendshipDtos.Where(x => x.User1Id == user.Id || x.User2Id == user.Id).IsNullOrEmpty())
                                {
                                    //remove friend for the future
                                    <input type="submit" value="Already friends" class="btn btn-default" />
                                }
                                else
                                {
                                    using (Html.BeginForm("AddFriend", "UsersManager", new { id = user.Id }, FormMethod.Post, null))
                                    {
                                        <input type="submit" value="Add friend" class="btn btn-primary" />
                                    }
                                }
                            }
                        </td>
                    </tr>
                }
            }
            </tbody>
        </table>
    </div>
    <div class="col-md-4 pull-right sidebar">
        <div class="city"></div>
        <blockquote>
            <footer>Existuje mnoho variant s pasážemi Lorem Ipsum, nicméně valná většina trpí neduhy v podobě snahy o vtipný text či použití naprosto náhodných slov, což nevypadá zrovna uvěřitelně.</footer>
        </blockquote>
    </div>
    <div class="clearfix"></div>
                                }